# ============================================================
#  Telegraf Configuration for TIG + NCM app (Windows Fixed)
#  Save as: telegraf.conf
# ============================================================

# ---------- Global Tags ----------
[global_tags]
  env = "prod"
  host = "$HOSTNAME"

# ---------- Agent Basics ----------
[agent]
  interval = "30s"          # match your app's default; you can change from UI later
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  logfile = ""              # set a path if you want a file log
  debug = false
  quiet = false
  hostname = ""             # leave empty to use OS hostname
  skip_processors_after_aggregators = false  # Explicit setting to avoid future warning

# ============================================================
# INPUTS (Host)
# ============================================================

# CPU usage (per-CPU + total)
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = true

# Memory usage
[[inputs.mem]]

# Disk usage (Windows drives)
[[inputs.disk]]
  mount_points = ["C:"]  # Adjusted for Windows
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "overlay", "aufs", "squashfs"]

# Disk I/O
[[inputs.diskio]]

# Network interface stats (fixed deprecation warning)
[[inputs.net]]
  interfaces = ["*"]  # Windows interfaces
  ignore_protocol_stats = false  # Set to false to avoid deprecation warning

# System load/uptime  
[[inputs.system]]

# Note: Removed [[inputs.processes]] as it's not supported on Windows

# ============================================================
# OPTIONAL: Ping your network devices so you also see reachability
#           (uncomment and list your device IPs/hostnames)
# ============================================================
 [[inputs.ping]]
   ## Hosts to ping
   urls = ["192.168.29.161","192.168.29.162","router.local"]
   ## Ping interval per host
   interval = "30s"
   ## Timeout for each ping
   timeout = "2s"
   ## Number of pings per collection interval
   count = 3
   privileged = false          # Windows doesn't need privileged mode

# ============================================================
# OPTIONAL: SNMP poll network devices (example; fill credentials)
# ============================================================
# [[inputs.snmp]]
#   agents = ["192.168.29.161:161"]
#   version = 2
#   community = "public"
#   name = "snmp_device"
#   [[inputs.snmp.field]]
#     name = "sysUpTime"
#     oid = "1.3.6.1.2.1.1.3.0"
#   [[inputs.snmp.field]]
#     name = "ifNumber"
#     oid  = "1.3.6.1.2.1.2.1.0"

# ============================================================
# OUTPUTS
# ============================================================

# ---- InfluxDB v2 (primary sink for Grafana + data explorer) ----
[[outputs.influxdb_v2]]
  # If Influx runs elsewhere, change the URL accordingly.
  urls = ["http://localhost:8086"]

  # Your InfluxDB credentials
  token = "4gI-2t-1FOYtW9n1iNT8eSj-iPkU1kLFJ8B0s6yzShaJEl0VEJk8VDFY-kY4LAfaN7mFjRO057tU5ODxji2PKw=="
  organization = "Vayu"
  bucket = "Vayu"

  # (optional) write precision
  # precision = "ns"

# ---- Prometheus scrape endpoint (so Flask can check Telegraf) ----
# Exposes metrics at http://<this-host>:9273/metrics
[[outputs.prometheus_client]]
  listen = ":9273"
  path = "/metrics"
  expiration_interval = "60s"
  collectors_exclude = ["gocollector", "process"]  # keep output focused

# ============================================================
# PROCESSORS (optional but handy)
# ============================================================
# Example: drop noisy fields or reduce cardinality
# [[processors.converter]]
#   [processors.converter.tags]
#     string = ["host"]

# [[processors.regex]]
#   namepass = ["net"]
#   [[processors.regex.tags]]
#     key = "interface"
#     pattern = "^(Ethernet|enp.*|eth.*)$"
#     replacement = "${1}"

# ============================================================
# WINDOWS SERVICE INSTALLATION
# Run PowerShell as Administrator:
#   .\telegraf.exe --service install --config "C:\telegraf\telegraf-1.36.1_windows_amd64\telegraf-1.36.1\telegraf.conf"
#   .\telegraf.exe --service start
# ============================================================